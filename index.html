<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script>

screenWidthMillis = 600
distanceToScreenMillis = 1000
eyesDistanceMillis = 62

colorRedValue = 0
colorGreenValue = 0
colorBlueValue = 0

const depthMillis = 2000

//--------------------------------------------------------------
/*
let program = {
    shaders: [
        { type: "VERTEX_SHADER", src: vertexShaderSrc, },
        { type: "FRAGMENT_SHADER", src: fragmentShaderSrc, }
    ],
    
    uniforms: {
        projectionViewMatrix: null,
    },
    
    vertexSpecification: [
        // attributes, located in the same buffer
        // {
        //     type: "FLOAT", // type of values in buffer
        //     attributes: [
        //         {
        //             name: "AttributeName",
        //             sizeUnits: 4,
        //             offsetUnits: 0 //  OPTIONAL, offset in units (not in bytes), default automatic
        //             strideUnits: 0 //  OPTIONAL, stride in units (not in bytes), default automatic over all attributes in buffer
        //             normalized: 0  //  OPTIONAL, default false
        //         },
        //     ]
        //     buffer:        //  OPTIONAL, explicit buffer specification, default automatic buffer allocation
        // },
        {
            type: "FLOAT",
            attributes: [
                {
                    name: "pos",
                    sizeUnits: 4,
                },
                {
                    name: "color",
                    sizeUnits: 4,
                },
            ]
        },
    ]
}
*/

//--------------------------------------------------------------
class BufferBuilder {
    constructor(program) {
        if (!program.ready) throw new Error('Program is not compiled yet')
        
        this.program = program
        this.size = 0
        this.vertexArrays = program.vertexSpecification.map(x => new Array)
        
        this.drawcalls = {}
    }
    
    clear() {
        for ( let vertexArray of this.vertexArrays ) vertexArray.length = 0
        
        this.size = 0
        this.drawcalls = {}
    }
    
    addVertex(vertex, index) {
        if ( index === undefined ) {
            index = this.size
        }
        for ( let i = 0; i < this.program.vertexSpecification.length; i++ ) {
            let vertexArray = this.vertexArrays[i]
            for ( const attr of this.program.vertexSpecification[i].attributes ) {
                let vertexAttr = vertex[attr.name]
                if ( vertexAttr===undefined ) throw new Error(`"${attr.name}" required in vertex specification`)
                if ( vertexAttr[0]===undefined ) vertexAttr = [vertexAttr]
                if ( vertexAttr.length != attr.sizeUnits) {
                    throw new Error(`"${attr.name}" attribute must be of lenth ${attr.sizeUnits}`)
                }
                for ( let k = 0; k < attr.sizeUnits; k++ ) {
                    vertexArray[attr.offsetUnits + index*attr.strideUnits + k] = vertexAttr[k]
                }
            }
        }
        
        if ( index >= this.size ) this.size = index + 1;
        
        return index
    }
    
    addIndices(name, type, ...indices) {
        if ( !this.drawcalls[name] ) {
            this.drawcalls[name] = {
                indices: [],
                type: type,
            }
        } else {
            if ( this.drawcalls[name].type != type ) throw new Error('Drawcall type mismatch')
        }
        
        this.drawcalls[name].indices.push(...indices)
    }
    
    uploadData() {
        let gl = this.program.gl
        
        gl.useProgram(this.program.program)
        gl.bindVertexArray(this.program.vao)
        
        for ( let i = 0; i < this.program.vertexSpecification.length; i++ ) {
            let spec = this.program.vertexSpecification[i]
            
            gl.bindBuffer(gl.ARRAY_BUFFER, spec.buffer)
            gl.bufferData(
                gl.ARRAY_BUFFER,
                new dataTypes[spec.type].arrayType(this.vertexArrays[i]),
                gl.STATIC_DRAW
            )
        }
        
        let pos = 0
        let dataType = 'UNSIGNED_SHORT'
        for ( let drawcall of Object.values(this.drawcalls) ) {
            drawcall.dataType = dataType
            drawcall.start = pos
            drawcall.count = drawcall.indices.length
            pos += drawcall.count
            drawcall.program = this.program
            drawcall.draw = function() {
                gl.drawElements(
                    gl[this.type],
                    this.count,
                    gl[this.dataType],
                    this.start * dataTypes[this.dataType].size
                )
            }
        }
        
        let allIndices = new dataTypes[dataType].arrayType(pos)
        for ( let drawcall of Object.values(this.drawcalls) ) {
            allIndices.set(drawcall.indices, drawcall.start)
        }
        
        gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, allIndices, gl.STATIC_DRAW)
        
        // this.clear()
        return this.drawcalls
    }
}

//--------------------------------------------------------------
function resolveConstant(gl, value) {
    return typeof value == 'string' ? gl[value] : value
}

//--------------------------------------------------------------
const dataTypes = {
    BYTE:           { size: 1, arrayType: Int8Array },
    UNSIGNED_BYTE:  { size: 1, arrayType: Uint8Array },
    SHORT:          { size: 2, arrayType: Int16Array },
    UNSIGNED_SHORT: { size: 2, arrayType: Uint16Array },
    INT:            { size: 4, arrayType: Int32Array },
    UNSIGNED_INT:   { size: 4, arrayType: Uint32Array },
    FLOAT:          { size: 4, arrayType: Float32Array },
}

//--------------------------------------------------------------
function buildProgram(gl, program) {
    program.program = gl.createProgram()
    
    for ( let shader of program.shaders ) {
        shader.shader = gl.createShader(resolveConstant(gl, shader.type))
        gl.shaderSource(shader.shader, shader.src)
        gl.compileShader(shader.shader)
        if ( !gl.getShaderParameter(shader.shader, gl.COMPILE_STATUS) ) {
            console.log(`Compile error: ${gl.getShaderInfoLog(shader.shader)}`)
        }
        gl.attachShader(program.program, shader.shader)
    }
    
    gl.linkProgram(program.program)
    
    for ( let shader of program.shaders ) {
        gl.deleteShader(shader.shader)
        delete shader.shader
    }
    
    if(!gl.getProgramParameter(program.program, gl.LINK_STATUS)) {
        const shaderError = gl.getProgramInfoLog(program.program)
        throw new Error(`Shader error: ${shaderError}`)
    }
    
    program.vao = gl.createVertexArray()
    gl.bindVertexArray(program.vao)
    
    if ( !program.indexBuffer ) program.indexBuffer = gl.createBuffer()
    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, program.indexBuffer)
    
    for ( let spec of program.vertexSpecification ) {
        if ( !spec.buffer ) spec.buffer = gl.createBuffer()
        
        gl.bindBuffer(gl.ARRAY_BUFFER, spec.buffer)
        const unitSize = dataTypes[spec.type].size
        let strideUnits = spec.attributes.reduce((accum, attr) => accum + attr.sizeUnits, 0)
        var offsetUnits = 0
        
        for ( let attr of spec.attributes ) {
            attr.location = gl.getAttribLocation(program.program, attr.name)
            if ( attr.location == -1 ) throw new Error(`Vertex attribut name not found: ${attr.name}`)
            
            if ( attr.offsetUnits === undefined ) attr.offsetUnits = offsetUnits
            if ( attr.strideUnits === undefined ) attr.strideUnits = strideUnits
            
            gl.vertexAttribPointer(
                attr.location,
                attr.sizeUnits,
                resolveConstant(gl, spec.type),
                attr.normalized,
                attr.strideUnits * unitSize,
                attr.offsetUnits * unitSize
            )
            gl.enableVertexAttribArray(attr.location)
            offsetUnits += attr.sizeUnits
        }
    }
    
    for ( let uniform in program.uniforms ) {
        program.uniforms[uniform] = gl.getUniformLocation(program.program, uniform)
        if ( program.uniforms[uniform] === null ) throw new Error(`Uniform not found: ${uniform}`)
    }
    
    program.gl = gl
    program.ready = true
}

//--------------------------------------------------------------


//============================================================
// Matrix functions


//--------------------------------------------------------------
function identity() {
    let mat = new Float32Array(16)
    mat[0] = mat[5] = mat[10] = mat[15] = 1.0
    return mat
}

//--------------------------------------------------------------
function frustum(left, right, bottom, top, near, far) {
    let mat = new Float32Array(16)
    
    mat[0] = 2 * near / (right - left)
    mat[1] = 0
    mat[2] = 0
    mat[3] = 0
    
    mat[4] = 0
    mat[5] = 2 * near / (top - bottom)
    mat[6] = 0
    mat[7] = 0
    
    mat[8] = (right + left) / (right - left)
    mat[9] = (top + bottom) / (top - bottom)
    mat[10] = - (far + near) / (far - near)
    mat[11] = -1
    
    mat[12] = 0
    mat[13] = 0
    mat[14] = - 2 * far * near / (far - near)
    mat[15] = 0
    
    return mat
}

//--------------------------------------------------------------
function mulMatrix(mat1, mat2) {
    let mat = new Float32Array(16)
    
    for (var row=0; row<4; row++) {
        for (var col=0; col<16; col+=4) {
            mat[row+col] = (
                mat1[row]      * mat2[col] + 
                mat1[row + 4]  * mat2[col + 1] + 
                mat1[row + 8]  * mat2[col + 2] + 
                mat1[row + 12] * mat2[col + 3]
            )
        }
    }
    
    return mat
}

//--------------------------------------------------------------
function translateInplace(mat, dx, dy, dz) {
    mat[12] += mat[0]*dx + mat[4]*dy + mat[8]*dz
    mat[13] += mat[1]*dx + mat[5]*dy + mat[9]*dz
    mat[14] += mat[2]*dx + mat[6]*dy + mat[10]*dz
    mat[15] += mat[3]*dx + mat[7]*dy + mat[11]*dz
}

//--------------------------------------------------------------
function rotateInplace(mat, axis1, axis2, angle) {
    let index1 = axis1 * 4
    let index2 = axis2 * 4
    let c = Math.cos(angle)
    let s = Math.sin(angle)
    for ( var i=0; i<4; i++ ) {
        let temp = mat[index1]*c + mat[index2]*s;
        mat[index2] = mat[index2]*c - mat[index1]*s;
        mat[index1] = temp;
        index1++;
        index2++;
    }
}


function printMatrix(m) {
    console.log('---------------')
    for ( let i of [0, 1, 2, 3] ) {
        console.log(m[i], m[i+4], m[i+8], m[i+12])
    }
}

// End of matrix functions
//============================================================

class Scene {
    vertices = [
        [0.94183034, 1.0978003, 4.875782],
        [0.71866673, 1.1421899, 4.1445351],
        [1.1891266, 0.89968961, 4.1190548],
        [1.1585734, 0.72216672, 4.4951587],
        [0.46641052, 0.50138974, 1.7482356],
        [0.22986579, 0.24880329, 1.5842009],
        [0.44467115, 0.075090244, 1.6060389],
        [0.6445893, 0.060245972, 1.7384337],
        [0.81774104, 0.65494788, 2.3127112],
        [0.74802518, 1.2629373, 2.4780695],
        [0.77793986, 0.95892727, 2.2987542],
        [1.0491517, 0.87396866, 2.3726718],
        [1.2830781, 0.39703742, 2.405498],
        [-0.15432201, 0.7626791, 2.7896838],
        [0.90544373, 0.72132742, 2.2700572],
        [0.33848265, 0.66049981, 2.5946681],
        [-0.14410724, 0.66604125, 2.8136499],
        [-0.14950503, -0.61869949, 2.7879839],
        [-0.13690917, -0.5227924, 2.8134799],
        [0.34567755, -0.52822715, 2.5944924],
        [0.82429552, -0.5336771, 2.3125699],
        [0.9116711, -0.5992288, 2.268199],
        [0.68529677, 0.6112743, 1.9979433],
        [-0.3026002, 0.52945757, 1.9386712],
        [-0.037764594, 2.3040056, 2.7170262],
        [-0.17873998, 1.1027089, 2.7349274],
        [0.28357321, 1.0765896, 2.5706682],
        [0.60828793, 2.3078828, 2.6832643],
        [-0.46092606, 0.89572352, 3.1461649],
        [-0.58182466, 0.40242019, 3.1881096],
        [-0.16753416, 0.77812374, 2.6462922],
        [-0.4227581, 0.28311175, 2.4425941],
        [-0.42568117, 0.60183144, 2.672545],
        [-0.61162031, 0.29478818, 2.6876152],
        [-0.41139209, 0.049140237, 2.3792026],
        [-0.41204405, 0.12981196, 2.3807299],
        [-0.57047111, 0.13671902, 2.6241579],
        [-0.36236185, 0.046512399, 2.6017537],
        [-0.36290205, 0.32397988, 2.6079769],
        [-0.36204773, -0.23088989, 2.6048067],
        [-0.57006216, -0.042358018, 2.6226132],
        [-0.604182, -0.032775812, 2.3788285],
        [-0.60517603, 0.12889944, 2.3818567],
        [-0.41098291, -0.031731345, 2.3776939],
        [-0.30698955, 0.39862043, 2.3656492],
        [-0.32654208, 0.5183515, 2.6013639],
        [-0.34523857, 0.22484668, 2.2677379],
        [0.94318867, -0.98291624, 4.8699999],
        [1.1860893, -0.60130018, 4.5027094],
        [1.1988699, -0.77520567, 4.1185198],
        [0.73176408, -1.0220102, 4.1441388],
        [0.47087419, -0.38285437, 1.747013],
        [0.23180825, -0.13316974, 1.5839515],
        [1.0844026, 0.062094167, 2.2599373],
        [0.76188523, -1.1421145, 2.4777532],
        [0.78833836, -0.83790445, 2.2985151],
        [1.0254316, -0.74905211, 2.3741939],
        [1.2868608, -0.26973128, 2.4054124],
        [-0.29886746, -0.42010972, 1.936641],
        [0.69063705, -0.49116451, 1.9964095],
        [0.28157505, -0.96162307, 2.5711257],
        [-0.19435404, -0.99349713, 2.7361097],
        [-0.010745525, -2.1922512, 2.7163823],
        [0.63524473, -2.1882319, 2.6826274],
        [-0.45060372, -0.78752589, 3.145916],
        [-0.17310511, -0.65190071, 2.6468339],
        [-0.57768065, -0.26426834, 3.1880088],
        [-0.42171276, -0.50976473, 2.6683912],
        [-0.42051762, -0.18195628, 2.4386394],
        [-0.60975581, -0.19899198, 2.6851287],
        [-1.1380693, -0.4292601, 2.9882159],
        [-0.32589346, -0.43001348, 2.5980625],
        [-0.32627279, 0.04426397, 2.5997109],
        [-1.1479528, 0.53275084, 2.9919996],
        [-0.30781496, -0.30404788, 2.3651319],
        [-0.34123343, -0.12525275, 2.2638721],
        [-0.58850718, -0.28197417, 4.787919],
        [-0.93303335, -0.28626716, 4.2681522],
        [-0.94263089, 0.39909953, 4.266427],
        [-0.58182514, 0.37512228, 4.8109055],
        [1.1755874, -0.26568142, 4.4960408],
        [1.1785164, 0.40614209, 4.4720325],
        [1.2510502, 0.39664164, 4.1229415],
        [1.2562075, -0.27010164, 4.1217213],
        [0.58690763, -2.9673247, 2.9947779],
        [0.59880614, -2.7673244, 3.2454369],
        [0.56769997, -2.7674265, 2.6501431],
        [0.57447463, -2.9673657, 2.7568436],
        [-1.4460928, -0.26216593, 3.4890461],
        [-1.0541164, -0.48283088, 3.5245068],
        [-1.4620675, -0.25259852, 3.3928993],
        [-1.4697737, 0.3585009, 3.3962889],
        [-1.449916, 0.37082735, 3.4892769],
        [-1.0608103, 0.60758442, 3.5249093],
        [1.1751661, 0.30202043, 6.2382264],
        [0.99158239, 0.18727393, 6.0477881],
        [1.0272083, 0.18736206, 6.9313293],
        [1.2005699, 0.30207843, 6.9040909],
        [1.0898879, 0.88034511, 6.2425747],
        [0.87712884, 0.96345341, 6.0536251],
        [1.1152916, 0.88040257, 6.9084477],
        [0.9127546, 0.96354109, 6.9371796],
        [0.066040397, 0.9911359, 6.544446],
        [0.090370759, 0.95865899, 6.6290274],
        [-0.014474154, 0.18116465, 6.6346416],
        [-0.039691448, 0.15697835, 6.5524988],
        [0.78200454, 1.0628707, 6.1587219],
        [0.80695713, 1.0629528, 6.6356153],
        [0.92287552, 0.086777985, 6.6348376],
        [0.89765608, 0.086695217, 6.1528478],
        [1.1441439, 0.87400603, 4.0272532],
        [1.1470292, 0.39603806, 4.0271845],
        [1.1730125, 0.10025999, 4.931879],
        [1.0525352, 0.087801494, 4.9926391],
        [0.90579289, 1.0637602, 4.9506164],
        [0.69695365, 1.0601066, 4.0505886],
        [0.81050807, 1.1631211, 5.0557108],
        [0.9476642, 1.0639205, 5.7495127],
        [0.84190923, 1.1632409, 5.654892],
        [1.1706297, 0.20143519, 5.6378894],
        [1.0916582, 0.08791621, 5.7421627],
        [1.0558909, 0.97960657, 5.6437488],
        [1.1416738, 0.20136788, 5.0832067],
        [1.0247148, 0.97945893, 5.0497074],
        [0.45136791, 3.4853702, 2.8300257],
        [0.5368157, 3.2858815, 2.7577376],
        [0.54924828, 3.2859211, 2.9956686],
        [0.45672941, 3.4853902, 2.9326153],
        [0.53801364, 3.0858865, 2.7577093],
        [0.55044663, 3.085927, 2.9956403],
        [0.53363478, 2.8858371, 2.6509497],
        [0.56474149, 2.8859396, 3.2462447],
        [-0.29772788, 0.61276734, 2.8935339],
        [-0.29115534, -0.47791374, 2.8931396],
        [0.63316953, 2.3079624, 3.1609454],
        [0.7924819, 1.2631034, 3.3420875],
        [1.0940059, 0.8737573, 3.3621845],
        [1.3321102, 0.3972427, 3.3498242],
        [0.86374104, 0.061102446, 1.9879948],
        [-0.062085435, 0.15972976, 6.1926126],
        [-0.042527393, 0.18107191, 6.1018391],
        [0.062317103, 0.95856625, 6.0962143],
        [0.0398307, 0.98953277, 6.1871452],
        [-0.84480411, 0.39221269, 4.1418576],
        [-0.57244116, 0.82022583, 4.1329427],
        [-0.58043784, 0.87571192, 4.2361441],
        [0.031192258, 1.0561368, 4.0853782],
        [0.037212998, 1.1451752, 4.1810966],
        [-0.082430974, 1.0578564, 5.0022621],
        [-0.12612598, 1.0936823, 4.9306202],
        [-0.21154802, 0.080219522, 5.0586905],
        [-0.35135329, 0.079799861, 5.0655684],
        [-0.39813387, 0.79632151, 4.7157497],
        [-0.0406854, 1.0579927, 5.8011742],
        [0.053301856, 1.1585079, 5.6961031],
        [0.021989644, 1.1584101, 5.0969172],
        [-0.076300755, 0.89994609, 6.0401039],
        [-0.16163509, 0.26738194, 6.0446711],
        [-0.11412464, 0.93648499, 5.9316888],
        [-0.2093824, 0.23036072, 5.9367847],
        [-0.17245309, 0.080333889, 5.8082218],
        [-0.15813832, 0.97222978, 5.7071958],
        [-0.26330352, 0.19276635, 5.7128105],
        [-0.1891803, 0.972121, 5.1131439],
        [-0.29221684, 0.19268811, 5.1581302],
        [0.088663876, 0.19701426, 1.5953903],
        [-0.20214044, 0.33552751, 1.7186333],
        [-0.082619265, 0.19958985, 1.6307468],
        [-0.75030249, 0.88439018, 6.9397845],
        [-0.54538643, 0.98446572, 7.0291905],
        [-0.54515231, 0.20760116, 7.0293121],
        [-0.75012732, 0.30752516, 6.939868],
        [-0.75593913, 0.88437277, 6.831912],
        [-0.5614602, 0.98441344, 6.721581],
        [-0.75576484, 0.30750734, 6.8320017],
        [-0.56122613, 0.20754886, 6.7217169],
        [-0.24579428, 0.98455405, 7.0135517],
        [-0.24556012, 0.20768905, 7.0136576],
        [-0.26950836, 0.98447633, 6.557538],
        [-0.2692734, 0.20761168, 6.5576735],
        [0.10948782, 0.95872164, 6.9949751],
        [0.0046018213, 0.1812268, 7.0006037],
        [0.8849144, 0.18558568, 6.9458151],
        [0.77050233, 0.96176571, 6.9516649],
        [-0.077167436, 3.2695441, 2.8515537],
        [0.029178008, 3.2828364, 2.7842646],
        [0.041610517, 3.282876, 3.022197],
        [-0.071168274, 3.2695646, 2.9663601],
        [-0.076560453, 3.1682973, 2.8515406],
        [0.030375928, 3.0828414, 2.7842362],
        [-0.070561275, 3.1683178, 2.966347],
        [0.042808905, 3.0828819, 3.022167],
        [0.12467137, 3.4833965, 2.9499655],
        [0.11931038, 3.4833779, 2.8473744],
        [-0.28695232, 0.44798148, 1.9950784],
        [-0.18261378, 0.30680817, 1.7942424],
        [-0.38625807, 0.12353735, 2.1100879],
        [-0.3346839, 0.22198044, 2.139729],
        [-0.28750688, 0.36642313, 2.1177144],
        [-0.57264543, 0.12247441, 2.236975],
        [0.057103716, 2.8828945, 3.2727718],
        [0.025997534, 2.8827929, 2.6774757],
        [-0.012882575, 2.3040891, 3.1947045],
        [-0.13955764, 1.1441575, 3.3908105],
        [-0.60470062, 0.82008058, 3.7954998],
        [-0.75089359, 0.39501768, 3.8055243],
        [0.29956675, 0.86849779, 2.3669202],
        [1.1000957, -0.75533497, 6.242322],
        [0.88835984, -0.8421517, 6.0533562],
        [0.92409724, -0.84206271, 6.936903],
        [1.1254561, -0.75527704, 6.9081936],
        [1.1784072, -0.17599286, 6.2381382],
        [0.99346089, -0.064617999, 6.0477352],
        [1.2037672, -0.17593537, 6.9040027],
        [1.0291983, -0.064529002, 6.9312782],
        [0.89823163, 0.034798481, 6.1528387],
        [0.92348087, 0.03488113, 6.6348066],
        [0.81931072, -0.94265026, 6.6353073],
        [0.79432851, -0.94273126, 6.1584234],
        [1.1511718, -0.27072865, 4.0270796],
        [1.1541078, -0.74822921, 4.02701],
        [0.91809517, -0.94181812, 4.9503236],
        [1.0528718, 0.035902373, 4.9926262],
        [1.1733165, 0.029886479, 4.9184241],
        [0.70900595, -0.94017267, 4.0502987],
        [1.0671325, -0.85601038, 5.6434593],
        [0.96001244, -0.94168168, 5.7492323],
        [1.0921088, 0.036017969, 5.7421589],
        [1.1724387, -0.076506689, 5.6378288],
        [1.0359845, -0.85611856, 5.0494175],
        [1.1434178, -0.076586708, 5.0831389],
        [0.85559297, -1.0422955, 5.6545768],
        [0.82417643, -1.0423979, 5.0553961],
        [0.51737565, -3.3676558, 2.934058],
        [0.58802533, -3.1673536, 2.99475],
        [0.57559192, -3.1673946, 2.7568154],
        [0.51165652, -3.3676748, 2.8246078],
        [0.66025436, -2.1882882, 3.1602974],
        [0.8072623, -1.1417294, 3.3417265],
        [1.132658, -0.74810469, 3.3604424],
        [1.3361059, -0.26952487, 3.3497295],
        [-0.25814337, -0.87705523, 6.5571852],
        [0.10152118, -0.84694707, 6.6287565],
        [-0.012678251, -0.070728749, 6.6346059],
        [-0.26685351, -0.1002041, 6.5575113],
        [-0.036232457, -0.048424497, 6.5491295],
        [0.076542571, -0.8807804, 6.5463991],
        [0.051349521, -0.87830353, 6.1868629],
        [0.073465601, -0.84703988, 6.0959382],
        [-0.040734291, -0.070822001, 6.101789],
        [-0.060540229, -0.049746566, 6.1925879],
        [-0.58167529, -0.75149602, 4.2385616],
        [-0.58303791, -0.70432431, 4.1337619],
        [-0.84127921, -0.28363112, 4.1417894],
        [0.049653798, -1.0328026, 4.1811867],
        [0.043147042, -0.94416797, 4.085094],
        [-0.11454849, -0.98765779, 4.9474697],
        [-0.070134208, -0.9477458, 5.0019732],
        [-0.34490776, 0.017462134, 5.081109],
        [-0.21111982, 0.028321497, 5.058681],
        [-0.41213512, -0.68764883, 4.7089882],
        [0.067008056, -1.047025, 5.6957722],
        [-0.028216898, -0.94760835, 5.8008718],
        [0.035591826, -1.0471267, 5.0966091],
        [-0.1588041, -0.15853617, 6.0446062],
        [-0.065890655, -0.79006773, 6.0398574],
        [-0.20700042, -0.12205873, 5.9367189],
        [-0.17188232, 0.02843662, 5.8082151],
        [-0.1032836, -0.82702762, 5.9314332],
        [-0.26135874, -0.085086167, 5.7127733],
        [-0.1468579, -0.86325943, 5.7069368],
        [-0.29039699, -0.085164472, 5.1580958],
        [-0.17802094, -0.86337256, 5.1128883],
        [-0.080912381, -0.087675035, 1.6303493],
        [0.090322495, -0.083137304, 1.5952425],
        [-0.19883455, -0.22508377, 1.718091],
        [-0.74635744, -0.20574537, 6.9394889],
        [-0.54265928, -0.10349174, 7.0290389],
        [-0.53394872, -0.88034284, 7.0287285],
        [-0.73989022, -0.78260827, 6.9392548],
        [-0.75195152, -0.20576319, 6.8316097],
        [-0.55861247, -0.10354352, 6.7214231],
        [-0.74548382, -0.78262657, 6.8313665],
        [-0.54990184, -0.88039464, 6.7211123],
        [-0.24314652, -0.10012682, 7.0135045],
        [-0.2344359, -0.87697798, 7.0131826],
        [0.0063234419, -0.07066749, 7.0005536],
        [0.12052283, -0.84688538, 6.9947076],
        [0.78174335, -0.84383988, 6.9513884],
        [0.88684434, -0.066306122, 6.945776],
        [-0.012636319, -3.15692, 2.965476],
        [0.080418982, -3.1703486, 3.0212715],
        [0.067985535, -3.1703892, 2.7833383],
        [-0.018747777, -3.15694, 2.8485267],
        [-0.013226315, -3.0584049, 2.9654899],
        [0.079234317, -2.9704251, 3.0212998],
        [-0.019338265, -3.0584249, 2.8485396],
        [0.066801347, -2.9704647, 2.783366],
        [0.14109139, -3.3698964, 2.8439703],
        [0.14681056, -3.3698778, 2.9534197],
        [-0.28238052, -0.34061453, 1.9949688],
        [-0.17958961, -0.19792059, 1.7941707],
        [-0.33362973, -0.12194289, 2.1417384],
        [-0.38535118, -0.023038693, 2.1100714],
        [-0.28635317, -0.26293078, 2.1160975],
        [-0.57158417, -0.024278626, 2.2369466],
        [0.059988044, -2.7705679, 2.6766696],
        [0.091094241, -2.7704659, 3.2719622],
        [0.014057368, -2.1924114, 3.1940644],
        [-0.1260791, -1.0341338, 3.3904788],
        [-0.61530018, -0.70451057, 3.79632],
        [-0.7474401, -0.28087559, 3.8054605],
        [0.30217397, -0.74495733, 2.367065],
        [1.3757037, -0.11275384, 3.3057663],
        [1.3732121, 0.036870062, 3.451648],
        [1.3370121, 0.48264313, 3.1348941],
        [1.3395038, 0.33301923, 2.9890127],
        [1.1821531, 0.96031374, 2.8050175],
        [1.1398381, 0.8070839, 2.6589208],
        [0.75260115, 1.357224, 2.4474421],
        [0.75483072, 1.2075739, 2.3825736],
        [-0.08655335, 1.354382, 2.657115],
        [-0.084535465, 1.2047248, 2.6101894],
        [-0.42938107, 1.0058407, 3.0795357],
        [-0.42688948, 0.85621578, 2.9336543],
        [-0.60468405, 0.77514327, 3.2592599],
        [-0.60219246, 0.62551934, 3.1133785],
        [-0.68862814, 0.31634516, 3.5183306],
        [-0.68613654, 0.16672078, 3.3724492],
        [-0.78262895, -0.2017574, 3.7651472],
        [-0.78013736, -0.35138178, 3.6192658],
        [-0.70551449, -0.65001523, 4.0476131],
        [-0.7030229, -0.79963958, 3.9017317],
        [-0.28266406, -0.96605957, 4.1312904],
        [-0.28060478, -1.115719, 4.0889654],
        [0.52507716, -1.3045318, 4.0869637],
        [0.52161807, -1.0171946, 4.0888152],
        [1.1169775, -0.79892617, 3.9298351],
        [1.0094028, -0.92202884, 3.8869936],
        [1.2596706, -0.71209836, 3.8666606],
        [1.2621621, -0.86172175, 3.7207789],
        [-0.018520385, -1.1128838, 4.3192716],
        [-0.020084217, -1.0715008, 4.1200519],
        [0.49395746, -1.0636141, 4.2902708],
        [0.49647593, -1.27068, 4.2893925],
        [-0.016625091, -1.3588377, 4.1182003],
        [-0.00056807697, -1.318436, 4.3173528],
        [-0.21016936, -1.065083, 4.2849941],
        [-0.22467251, -0.99689329, 4.3256583],
        [-0.28820264, -1.1258782, 4.8026276],
        [-0.27482605, -0.86640114, 4.8600106],
        [0.021093346, -1.0238383, 4.8225069],
        [0.0048843473, -1.4340514, 4.8188448],
        [0.62126374, -0.95939147, 4.7849798],
        [0.62623954, -1.3671201, 4.7816706],
        [0.10752364, -1.2611816, 1.4032346],
        [0.11552557, -1.1774766, 1.4032729],
        [0.069728442, -1.2153282, 1.3913651],
        [0.031821299, -1.1694748, 1.4028721],
        [0.023819376, -1.2531798, 1.4028337],
        [0.14947529, -1.3153138, 1.9741131],
        [0.066728853, -1.2153283, 2.017735],
        [0.16692398, -1.1327915, 1.9741967],
        [-0.015596017, -1.1153429, 1.9733226],
        [-0.033044927, -1.2978652, 1.9732391],
        [0.12836599, -1.2866781, 1.4459219],
        [0.14081714, -1.15643, 1.4459815],
        [0.01057075, -1.1439788, 1.4453578],
        [-0.0018800646, -1.2742264, 1.4452981],
        [0.10408884, -1.2578046, 1.5382689],
        [0.11150109, -1.1802652, 1.5383044],
        [0.03396257, -1.1728524, 1.5379331],
        [0.026550315, -1.2503918, 1.5378976],
        [0.11119542, -1.2665901, 1.5687678],
        [0.1201411, -1.1730123, 1.5688106],
        [0.0265643, -1.1640664, 1.5683625],
        [0.017618619, -1.2576443, 1.5683197],
        [0.14279045, -1.3047763, 1.5535593],
        [0.15840013, -1.1414906, 1.5536342],
        [-0.0048836246, -1.1258802, 1.5528522],
        [-0.020493403, -1.2891665, 1.5527774],
        [0.14635849, -1.3093271, 1.5930301],
        [0.16276219, -1.1377333, 1.5931087],
        [-0.008829765, -1.1213294, 1.5922869],
        [-0.02523347, -1.2929231, 1.5922084],
        [0.15014614, -1.3143409, 1.666346],
        [0.16742507, -1.1335944, 1.6664287],
        [-0.013319194, -1.1163156, 1.6655631],
        [-0.030598365, -1.297062, 1.6654804],
        [0.18036915, -1.3516041, 1.7785519],
        [0.20415062, -1.1028348, 1.7786659],
        [-0.044615567, -1.0790529, 1.7774746],
        [-0.068397149, -1.3278217, 1.7773607],
        [0.20300053, -1.3795321, 1.8669282],
        [0.23165582, -1.0797803, 1.8670654],
        [-0.068092093, -1.051125, 1.86563],
        [-0.096747518, -1.3508763, 1.8654927],
        [0.21033868, -1.388726, 1.9194756],
        [0.2405986, -1.0721905, 1.9196205],
        [-0.075933307, -1.0419307, 1.9181048],
        [-0.10619268, -1.3584658, 1.9179598],
    ]
    
    faces1 = [
        [1, 2, 3],
        [1, 3, 4],
        [5, 6, 7],
        [8, 5, 7],
        [9, 10, 11],
        [9, 12, 10],
        [9, 13, 12],
        [14, 15, 9],
        [14, 9, 16],
        [14, 16, 17],
        [18, 19, 20],
        [18, 20, 21],
        [18, 21, 22],
        [23, 15, 14],
        [23, 14, 24],
        [23, 24, 5],
        [25, 26, 27],
        [25, 27, 28],
        [27, 10, 28],
        [29, 30, 17],
        [29, 17, 31],
        [29, 31, 26],
        [32, 33, 34],
        [35, 36, 37],
        [38, 35, 37],
        [39, 38, 37],
        [38, 40, 41],
        [42, 43, 36],
        [42, 36, 35],
        [42, 35, 44],
        [45, 46, 39],
        [45, 39, 36],
        [45, 36, 47],
        [48, 49, 50],
        [48, 50, 51],
        [52, 8, 7],
        [53, 52, 7],
        [21, 9, 15],
        [21, 15, 54],
        [21, 54, 22],
        [55, 21, 56],
        [55, 57, 21],
        [57, 58, 21],
        [6, 53, 7],
        [59, 18, 22],
        [59, 22, 60],
        [59, 60, 52],
        [61, 62, 63],
        [64, 61, 63],
        [64, 55, 61],
        [65, 62, 66],
        [65, 66, 19],
        [65, 19, 67],
        [68, 69, 70],
        [35, 38, 41],
        [44, 35, 41],
        [71, 72, 73],
        [71, 73, 46],
        [71, 46, 74],
        [72, 75, 76],
        [72, 76, 44],
        [72, 44, 40],
        [77, 78, 79],
        [77, 79, 80],
        [81, 82, 83],
        [81, 83, 84],
        [85, 86, 87],
        [85, 87, 88],
        [89, 90, 71],
        [89, 71, 91],
        [91, 71, 74],
        [91, 74, 92],
        [92, 93, 89],
        [92, 89, 91],
        [92, 74, 94],
        [92, 94, 93],
        [95, 96, 97],
        [95, 97, 98],
        [99, 100, 96],
        [99, 96, 95],
        [101, 102, 100],
        [101, 100, 99],
        [101, 99, 95],
        [101, 95, 98],
        [103, 104, 105],
        [103, 105, 106],
        [107, 100, 102],
        [107, 102, 108],
        [109, 97, 96],
        [109, 96, 110],
        [3, 111, 112],
        [3, 112, 83],
        [113, 114, 115],
        [113, 115, 1],
        [2, 116, 111],
        [2, 111, 3],
        [82, 4, 3],
        [82, 3, 83],
        [113, 1, 4],
        [113, 4, 82],
        [117, 115, 118],
        [117, 118, 119],
        [120, 121, 118],
        [120, 118, 122],
        [123, 114, 121],
        [123, 121, 120],
        [124, 115, 114],
        [124, 114, 123],
        [122, 118, 115],
        [122, 115, 124],
        [122, 124, 123],
        [122, 123, 120],
        [100, 118, 121],
        [100, 121, 96],
        [125, 126, 127],
        [125, 127, 128],
        [126, 129, 130],
        [126, 130, 127],
        [68, 40, 44],
        [68, 44, 69],
        [32, 36, 39],
        [32, 39, 33],
        [93, 94, 90],
        [93, 90, 89],
        [129, 131, 132],
        [129, 132, 130],
        [94, 133, 134],
        [94, 134, 90],
        [131, 28, 135],
        [131, 135, 132],
        [28, 10, 136],
        [28, 136, 135],
        [136, 10, 12],
        [136, 12, 137],
        [116, 136, 137],
        [116, 137, 111],
        [138, 137, 12],
        [138, 12, 13],
        [112, 111, 137],
        [112, 137, 138],
        [72, 40, 38],
        [72, 38, 73],
        [46, 73, 38],
        [46, 38, 39],
        [5, 8, 139],
        [5, 139, 23],
        [15, 23, 139],
        [15, 139, 54],
        [98, 97, 102],
        [98, 102, 101],
        [140, 141, 142],
        [140, 142, 143],
        [108, 102, 104],
        [108, 104, 103],
        [143, 142, 100],
        [143, 100, 107],
        [106, 105, 97],
        [106, 97, 109],
        [110, 96, 141],
        [110, 141, 140],
        [106, 140, 143],
        [106, 143, 103],
        [103, 143, 107],
        [103, 107, 108],
        [109, 110, 140],
        [109, 140, 106],
        [79, 144, 145],
        [79, 145, 146],
        [146, 145, 147],
        [146, 147, 148],
        [1, 115, 149],
        [1, 149, 150],
        [148, 147, 116],
        [148, 116, 2],
        [150, 149, 151],
        [150, 151, 152],
        [80, 79, 146],
        [80, 146, 153],
        [153, 146, 148],
        [153, 148, 150],
        [150, 148, 2],
        [150, 2, 1],
        [80, 153, 150],
        [80, 150, 152],
        [119, 118, 154],
        [119, 154, 155],
        [156, 149, 115],
        [156, 115, 117],
        [155, 154, 149],
        [155, 149, 156],
        [155, 156, 117],
        [155, 117, 119],
        [157, 142, 141],
        [157, 141, 158],
        [159, 154, 142],
        [159, 142, 157],
        [160, 161, 154],
        [160, 154, 159],
        [158, 141, 161],
        [158, 161, 160],
        [158, 160, 159],
        [158, 159, 157],
        [162, 154, 161],
        [162, 161, 163],
        [164, 149, 154],
        [164, 154, 162],
        [165, 151, 149],
        [165, 149, 164],
        [163, 161, 151],
        [163, 151, 165],
        [163, 165, 164],
        [163, 164, 162],
        [166, 6, 167],
        [166, 167, 168],
        [169, 170, 171],
        [169, 171, 172],
        [173, 174, 170],
        [173, 170, 169],
        [175, 176, 174],
        [175, 174, 173],
        [172, 171, 176],
        [172, 176, 175],
        [172, 175, 173],
        [172, 173, 169],
        [170, 177, 178],
        [170, 178, 171],
        [174, 179, 177],
        [174, 177, 170],
        [176, 180, 179],
        [176, 179, 174],
        [171, 178, 180],
        [171, 180, 176],
        [177, 181, 182],
        [177, 182, 178],
        [179, 104, 181],
        [179, 181, 177],
        [180, 105, 104],
        [180, 104, 179],
        [178, 182, 105],
        [178, 105, 180],
        [183, 97, 105],
        [183, 105, 182],
        [184, 102, 97],
        [184, 97, 183],
        [181, 104, 102],
        [181, 102, 184],
        [182, 181, 184],
        [182, 184, 183],
        [96, 121, 161],
        [96, 161, 141],
        [142, 154, 118],
        [142, 118, 100],
        [121, 114, 151],
        [121, 151, 161],
        [185, 186, 187],
        [185, 187, 188],
        [189, 190, 186],
        [189, 186, 185],
        [191, 192, 190],
        [191, 190, 189],
        [188, 187, 192],
        [188, 192, 191],
        [188, 191, 189],
        [188, 189, 185],
        [128, 127, 187],
        [128, 187, 193],
        [194, 186, 126],
        [194, 126, 125],
        [193, 187, 186],
        [193, 186, 194],
        [193, 194, 125],
        [193, 125, 128],
        [127, 130, 192],
        [127, 192, 187],
        [186, 190, 129],
        [186, 129, 126],
        [14, 17, 195],
        [14, 195, 24],
        [24, 195, 196],
        [24, 196, 167],
        [6, 5, 24],
        [6, 24, 167],
        [70, 41, 40],
        [70, 40, 68],
        [34, 37, 36],
        [34, 36, 32],
        [33, 39, 37],
        [33, 37, 34],
        [47, 36, 197],
        [47, 197, 198],
        [199, 195, 46],
        [199, 46, 45],
        [198, 197, 195],
        [198, 195, 199],
        [198, 199, 45],
        [198, 45, 47],
        [200, 197, 36],
        [200, 36, 43],
        [130, 132, 201],
        [130, 201, 192],
        [190, 202, 131],
        [190, 131, 129],
        [192, 201, 202],
        [192, 202, 190],
        [74, 46, 133],
        [74, 133, 94],
        [46, 195, 17],
        [46, 17, 133],
        [132, 135, 203],
        [132, 203, 201],
        [202, 25, 28],
        [202, 28, 131],
        [201, 203, 25],
        [201, 25, 202],
        [135, 136, 204],
        [135, 204, 203],
        [203, 204, 26],
        [203, 26, 25],
        [67, 19, 17],
        [67, 17, 30],
        [205, 29, 26],
        [205, 26, 204],
        [147, 204, 136],
        [147, 136, 116],
        [145, 205, 204],
        [145, 204, 147],
        [206, 30, 29],
        [206, 29, 205],
        [144, 206, 205],
        [144, 205, 145],
        [26, 31, 207],
        [26, 207, 27],
        [10, 27, 207],
        [10, 207, 11],
        [9, 11, 207],
        [9, 207, 16],
        [17, 16, 207],
        [17, 207, 31],
        [208, 209, 210],
        [208, 210, 211],
        [212, 213, 209],
        [212, 209, 208],
        [214, 215, 213],
        [214, 213, 212],
        [214, 212, 208],
        [214, 208, 211],
        [216, 213, 215],
        [216, 215, 217],
        [218, 210, 209],
        [218, 209, 219],
        [84, 220, 221],
        [84, 221, 50],
        [83, 112, 220],
        [83, 220, 84],
        [48, 222, 223],
        [48, 223, 224],
        [224, 223, 114],
        [224, 114, 113],
        [50, 221, 225],
        [50, 225, 51],
        [49, 81, 84],
        [49, 84, 50],
        [48, 224, 81],
        [48, 81, 49],
        [224, 113, 82],
        [224, 82, 81],
        [226, 227, 228],
        [226, 228, 229],
        [230, 222, 227],
        [230, 227, 226],
        [231, 223, 222],
        [231, 222, 230],
        [229, 228, 223],
        [229, 223, 231],
        [229, 231, 230],
        [229, 230, 226],
        [232, 227, 222],
        [232, 222, 233],
        [213, 228, 227],
        [213, 227, 209],
        [234, 235, 236],
        [234, 236, 237],
        [235, 85, 88],
        [235, 88, 236],
        [86, 238, 64],
        [86, 64, 87],
        [238, 239, 55],
        [238, 55, 64],
        [21, 58, 13],
        [21, 13, 9],
        [239, 240, 57],
        [239, 57, 55],
        [225, 221, 240],
        [225, 240, 239],
        [241, 138, 13],
        [241, 13, 58],
        [240, 241, 58],
        [240, 58, 57],
        [220, 112, 138],
        [220, 138, 241],
        [221, 220, 241],
        [221, 241, 240],
        [22, 54, 139],
        [22, 139, 60],
        [52, 60, 139],
        [52, 139, 8],
        [242, 243, 244],
        [242, 244, 245],
        [211, 210, 215],
        [211, 215, 214],
        [246, 244, 243],
        [246, 243, 247],
        [248, 249, 250],
        [248, 250, 251],
        [217, 215, 244],
        [217, 244, 246],
        [251, 250, 213],
        [251, 213, 216],
        [247, 243, 210],
        [247, 210, 218],
        [219, 209, 249],
        [219, 249, 248],
        [247, 248, 251],
        [247, 251, 246],
        [246, 251, 216],
        [246, 216, 217],
        [218, 219, 248],
        [218, 248, 247],
        [252, 253, 254],
        [252, 254, 78],
        [78, 254, 144],
        [78, 144, 79],
        [255, 256, 253],
        [255, 253, 252],
        [51, 225, 256],
        [51, 256, 255],
        [257, 258, 222],
        [257, 222, 48],
        [259, 260, 258],
        [259, 258, 257],
        [152, 151, 260],
        [152, 260, 259],
        [261, 252, 78],
        [261, 78, 77],
        [261, 257, 255],
        [261, 255, 252],
        [257, 48, 51],
        [257, 51, 255],
        [261, 77, 259],
        [261, 259, 257],
        [77, 80, 152],
        [77, 152, 259],
        [262, 263, 227],
        [262, 227, 232],
        [264, 258, 263],
        [264, 263, 262],
        [233, 222, 258],
        [233, 258, 264],
        [232, 233, 264],
        [232, 264, 262],
        [265, 250, 249],
        [265, 249, 266],
        [267, 268, 250],
        [267, 250, 265],
        [269, 263, 268],
        [269, 268, 267],
        [266, 249, 263],
        [266, 263, 269],
        [266, 269, 267],
        [266, 267, 265],
        [270, 268, 263],
        [270, 263, 271],
        [272, 260, 268],
        [272, 268, 270],
        [273, 258, 260],
        [273, 260, 272],
        [271, 263, 258],
        [271, 258, 273],
        [271, 273, 272],
        [271, 272, 270],
        [274, 275, 166],
        [274, 166, 168],
        [168, 167, 276],
        [168, 276, 274],
        [275, 53, 6],
        [275, 6, 166],
        [274, 276, 53],
        [274, 53, 275],
        [277, 278, 279],
        [277, 279, 280],
        [281, 282, 278],
        [281, 278, 277],
        [283, 284, 282],
        [283, 282, 281],
        [280, 279, 284],
        [280, 284, 283],
        [280, 283, 281],
        [280, 281, 277],
        [278, 285, 286],
        [278, 286, 279],
        [282, 245, 285],
        [282, 285, 278],
        [284, 242, 245],
        [284, 245, 282],
        [279, 286, 242],
        [279, 242, 284],
        [285, 287, 288],
        [285, 288, 286],
        [245, 244, 287],
        [245, 287, 285],
        [286, 288, 243],
        [286, 243, 242],
        [289, 210, 243],
        [289, 243, 288],
        [290, 215, 210],
        [290, 210, 289],
        [287, 244, 215],
        [287, 215, 290],
        [288, 287, 290],
        [288, 290, 289],
        [209, 227, 263],
        [209, 263, 249],
        [250, 268, 228],
        [250, 228, 213],
        [268, 260, 223],
        [268, 223, 228],
        [291, 292, 293],
        [291, 293, 294],
        [295, 296, 292],
        [295, 292, 291],
        [297, 298, 296],
        [297, 296, 295],
        [294, 293, 298],
        [294, 298, 297],
        [294, 297, 295],
        [294, 295, 291],
        [299, 293, 292],
        [299, 292, 300],
        [237, 236, 293],
        [237, 293, 299],
        [300, 292, 235],
        [300, 235, 234],
        [300, 234, 237],
        [300, 237, 299],
        [236, 88, 298],
        [236, 298, 293],
        [292, 296, 85],
        [292, 85, 235],
        [59, 301, 19],
        [59, 19, 18],
        [276, 302, 301],
        [276, 301, 59],
        [167, 196, 302],
        [167, 302, 276],
        [276, 59, 52],
        [276, 52, 53],
        [69, 44, 41],
        [69, 41, 70],
        [303, 304, 44],
        [303, 44, 76],
        [305, 301, 304],
        [305, 304, 303],
        [75, 72, 301],
        [75, 301, 305],
        [76, 75, 305],
        [76, 305, 303],
        [196, 195, 301],
        [196, 301, 302],
        [306, 304, 197],
        [306, 197, 200],
        [42, 44, 304],
        [42, 304, 306],
        [42, 306, 200],
        [42, 200, 43],
        [304, 301, 195],
        [304, 195, 197],
        [298, 307, 308],
        [298, 308, 296],
        [88, 87, 307],
        [88, 307, 298],
        [296, 308, 86],
        [296, 86, 85],
        [90, 134, 72],
        [90, 72, 71],
        [134, 19, 301],
        [134, 301, 72],
        [307, 63, 309],
        [307, 309, 308],
        [87, 64, 63],
        [87, 63, 307],
        [308, 309, 238],
        [308, 238, 86],
        [63, 62, 310],
        [63, 310, 309],
        [309, 310, 239],
        [309, 239, 238],
        [260, 151, 114],
        [260, 114, 223],
        [311, 310, 62],
        [311, 62, 65],
        [256, 225, 239],
        [256, 239, 310],
        [253, 256, 310],
        [253, 310, 311],
        [312, 67, 30],
        [312, 30, 206],
        [311, 65, 67],
        [311, 67, 312],
        [254, 312, 206],
        [254, 206, 144],
        [253, 311, 312],
        [253, 312, 254],
        [19, 66, 313],
        [19, 313, 20],
        [21, 20, 313],
        [21, 313, 56],
        [55, 56, 313],
        [55, 313, 61],
        [62, 61, 313],
        [62, 313, 66],
        [133, 17, 19],
        [133, 19, 134],
        [314, 315, 316],
        [314, 316, 317],
        [317, 316, 318],
        [317, 318, 319],
        [319, 318, 320],
        [319, 320, 321],
        [321, 320, 322],
        [321, 322, 323],
        [323, 322, 324],
        [323, 324, 325],
        [325, 324, 326],
        [325, 326, 327],
        [327, 326, 328],
        [327, 328, 329],
        [329, 328, 330],
        [329, 330, 331],
        [331, 330, 332],
        [331, 332, 333],
        [333, 332, 334],
        [333, 334, 335],
        [336, 337, 338],
        [336, 338, 339],
        [339, 338, 340],
        [339, 340, 341],
        [341, 340, 315],
        [341, 315, 314],
        [342, 343, 337],
        [342, 337, 344],
        [344, 337, 336],
        [344, 336, 345],
        [345, 336, 346],
        [345, 346, 347],
        [348, 335, 334],
        [348, 334, 349],
        [349, 334, 343],
        [349, 343, 342],
        [347, 346, 335],
        [347, 335, 348],
        [350, 351, 352],
        [350, 352, 353],
        [353, 352, 354],
        [353, 354, 355],
        [350, 348, 349],
        [350, 349, 351],
        [351, 349, 342],
        [351, 342, 352],
        [353, 347, 348],
        [353, 348, 350],
        [352, 342, 344],
        [352, 344, 354],
        [354, 344, 345],
        [354, 345, 355],
        [355, 345, 347],
        [355, 347, 353],
    ]
    
    vertexShaderSrc = `#version 300 es
        in vec4 pos;
        in vec4 color;
        
        uniform mat4 projectionViewMatrix;
        
        out vec4 f_color;
        
        void main() {
            gl_Position = projectionViewMatrix * pos;
            f_color = color;
        }
    `
    
    fragmentShaderSrc = `#version 300 es
        precision highp float;
        
        out vec4 FragColor;
        in vec4 f_color;
        
        void main() {
            FragColor = f_color;
        }
    `
    
    constructor(gl) {
        this.initParams()
        
        this.program = {
            shaders: [
                { type: "VERTEX_SHADER", src: this.vertexShaderSrc },
                { type: "FRAGMENT_SHADER", src: this.fragmentShaderSrc },
            ],
            uniforms: { projectionViewMatrix: null },
            vertexSpecification: [{
                type: "FLOAT",
                attributes: [
                    { name: "pos", sizeUnits: 4 },
                    { name: "color", sizeUnits: 4 },
                ]
            }]
        }
        buildProgram(gl, this.program)
        
        let builder = new BufferBuilder(this.program)
        
        this.addModel1(builder)
        
        this.drawcalls = builder.uploadData()
    }
    
    addModel1(builder) {
        const scale = 50
        
        const startIndex = builder.size
        
        let color = [1, 0, 0, 1]
        
        for ( const v of this.vertices ) {
            builder.addVertex({ pos: [-v[1]*scale, (4-v[2])*scale, -v[0]*scale, 1], color: color })
            color[1] = 1 - color[1]
        }
        
        for ( const face of this.faces1 ) {
            for ( const index of face ) {
                builder.addIndices('objects_triangles', 'TRIANGLES', index + startIndex - 1)
            }
        }
    }
    
    initParams() {
        this.distance = distanceToScreenMillis + depthMillis * 0.8
        this.alpha = 0
        this.beta = 0
    }
    
    draw(eyeShift) {
        let gl = this.program.gl
        
        gl.useProgram(this.program.program)
        gl.bindVertexArray(this.program.vao)
        
        let pvm = buildProjectionMatrix(gl, eyeShift)
        translateInplace(pvm, 0, 0, -this.distance)
        rotateInplace(pvm, 1, 2, this.beta)
        rotateInplace(pvm, 2, 0, this.alpha)
        
        gl.uniformMatrix4fv(
            this.program.uniforms.projectionViewMatrix,
            false,
            pvm
        )
        
        this.drawcalls.objects_triangles.draw()
    }
}

//--------------------------------------------------------------
// parallax in pixels:
// parallax = K * normDepth, where
// normDepth - depth from depth texture (in range 0.0 - 1.0)
// K = boxDepthMillis * eyesDistanceMillis * screen.width /
//             (screenWidthMillis * (boxDepthMillis + distanceToScreenMillis))

class Pad {
    vertexShaderSrc = `#version 300 es
        in vec2 pos;
        
        void main() {
            gl_Position = vec4(pos.x, pos.y, 0, 1.0);
        }
    `
    
    fragmentShaderSrc = `#version 300 es
        precision highp float;
        
        uniform sampler2D texLeft;
        uniform sampler2D texRight;
        uniform sampler2D noiseTex;
        uniform float k;
        uniform float randomShift;
        uniform vec3 color;
        
        out vec4 FragColor;
        
        float parallax(float normDepth) {
            return k * normDepth;
        }
        
        void main() {
            int width = textureSize(texLeft, 0).x;
            
            // scan left to right
            ivec2 noiseCoord = ivec2(gl_FragCoord);
            int par = max(int(parallax(texelFetch(texLeft, noiseCoord, 0).r)), 1);
            while ( noiseCoord.x + par < width ) {
                noiseCoord.x += par;
                par = max(int(parallax(texelFetch(texLeft, noiseCoord, 0).r)), 1);
            }
            
            noiseCoord.x -= int(randomShift);
            if ( noiseCoord.x < 0 ) noiseCoord.x += width;
            float noiseLeft = texelFetch(noiseTex, noiseCoord, 0).r;
            
            // scan right to left
            noiseCoord.x = int(gl_FragCoord.x);
            par = max(int(parallax(texelFetch(texRight, noiseCoord, 0).r)), 1);
            while ( noiseCoord.x >= par ) {
                noiseCoord.x -= par;
                par = max(int(parallax(texelFetch(texRight, noiseCoord, 0).r)), 1);
            }
            
            noiseCoord.x += int(randomShift);
            if ( noiseCoord.x >= width ) noiseCoord.x -= width;
            float noiseRight = texelFetch(noiseTex, noiseCoord, 0).r;
            
            float noise = (noiseLeft + noiseRight) > 1.0 ? 1.0 : 0.0;
            
            FragColor = vec4(noise + color.r, noise + color.g, noise + color.b, 1.0);
        }
    `
    
    constructor(gl) {
        this.program = {
            shaders: [
                { type: "VERTEX_SHADER", src: this.vertexShaderSrc },
                { type: "FRAGMENT_SHADER", src: this.fragmentShaderSrc },
            ],
            uniforms: { texLeft: null, texRight: null, noiseTex: null, k: null, randomShift: null, color: null },
            vertexSpecification: [{
                type: "FLOAT",
                attributes: [
                    { name: "pos", sizeUnits: 2 },
                ],
            }],
        }
        buildProgram(gl, this.program)
        
        let builder = new BufferBuilder(this.program)
        
        let v1 = builder.addVertex({ pos: [ -1.0, -1.0 ] })
        let v2 = builder.addVertex({ pos: [ 1.0, -1.0 ] })
        let v3 = builder.addVertex({ pos: [ 1.0, 1.0 ] })
        let v4 = builder.addVertex({ pos: [ -1.0, 1.0 ] })
        
        builder.addIndices("pad_triangles", "TRIANGLES", v1, v2, v3)
        builder.addIndices("pad_triangles", "TRIANGLES", v3, v4, v1)
        
        this.drawcalls = builder.uploadData()
        
        this.noiseTex = gl.createTexture()
        gl.bindTexture(gl.TEXTURE_2D, this.noiseTex)
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.DEPTH_COMPONENT32F, gl.canvas.width, gl.canvas.height, 0, gl.DEPTH_COMPONENT, gl.FLOAT, null)
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST)
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST)
        
        this.initParams()
    }
    
    initParams() {
        let gl = this.program.gl
        let noise = new Float32Array(gl.canvas.width * gl.canvas.height)
        for ( let i = 0; i < gl.canvas.width * gl.canvas.height; i++ ) {
            let value = Math.random()
            noise[i] = value
        }
        gl.bindTexture(gl.TEXTURE_2D, this.noiseTex)
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.DEPTH_COMPONENT32F, gl.canvas.width, gl.canvas.height, 0, gl.DEPTH_COMPONENT, gl.FLOAT, noise)
    }
    
    draw(depthTexLeft, depthTexRight) {
        let gl = this.program.gl
        gl.useProgram(this.program.program)
        gl.bindVertexArray(this.program.vao)
        
        gl.activeTexture(gl.TEXTURE0)
        gl.bindTexture(gl.TEXTURE_2D, depthTexLeft)
        gl.uniform1i(this.program.uniforms.texLeft, 0)
        
        gl.activeTexture(gl.TEXTURE1)
        gl.bindTexture(gl.TEXTURE_2D, depthTexRight)
        gl.uniform1i(this.program.uniforms.texRight, 1)
        
        gl.activeTexture(gl.TEXTURE2)
        gl.bindTexture(gl.TEXTURE_2D, this.noiseTex)
        gl.uniform1i(this.program.uniforms.noiseTex, 2)
        
        
        gl.uniform1f(
            this.program.uniforms.k,
            depthMillis * eyesDistanceMillis * screen.width /
                (screenWidthMillis * (depthMillis + distanceToScreenMillis))
        )
        
        if ( document.querySelector('#updateEntireCanvas').checked ) {
            gl.uniform1f(this.program.uniforms.randomShift, Math.random()*gl.canvas.width/4)
        }
        
        gl.uniform3f(
            this.program.uniforms.color,
            colorRedValue,
            colorGreenValue,
            colorBlueValue
        )
        
        this.drawcalls.pad_triangles.draw()
    }
}

//--------------------------------------------------------------
function buildProjectionMatrix(gl, eyeShift) {
    let millisPerPixel = screenWidthMillis / screen.width
    
    let projectionMatrix = frustum(
        -gl.canvas.width * millisPerPixel / 2 - eyeShift,
        gl.canvas.width * millisPerPixel / 2 - eyeShift,
        -gl.canvas.height * millisPerPixel / 2,
        gl.canvas.height * millisPerPixel / 2,
        distanceToScreenMillis,
        distanceToScreenMillis + depthMillis
    )
    
    translateInplace(projectionMatrix, -eyeShift, 0, 0)
    
    return projectionMatrix
}

//--------------------------------------------------------------
function setupGL(canvas) {
    let gl = canvas.getContext("webgl2", { antialias: false })
    gl.clearColor(0.0, 0.0, 0.0, 1.0)
    gl.enable(gl.DEPTH_TEST)
    gl.enable(gl.CULL_FACE)
    return gl
}

//--------------------------------------------------------------
function checkNumericParam(paramId, oldValue, minValue, maxValue) {
    let element = document.querySelector(paramId)
    let newValue = parseFloat(element.value)
    element.style.background = ''
    if ( isNaN(newValue) || newValue < minValue || newValue > maxValue ) {
        element.value = oldValue
        return oldValue
    } else {
        element.value = newValue
        return newValue
    }
}

//--------------------------------------------------------------
function updateViewParams() {
    screenWidthMillis = checkNumericParam('#screenWidth', screenWidthMillis, 10, NaN)
    distanceToScreenMillis = checkNumericParam('#distanceToScreen', distanceToScreenMillis, 10, NaN)
    eyesDistanceMillis = checkNumericParam('#eyesDistance', eyesDistanceMillis, 30, 100)
    colorRedValue = checkNumericParam('#colorRed', colorRedValue, -1.0, 1.0)
    colorGreenValue = checkNumericParam('#colorGreen', colorGreenValue, -1.0, 1.0)
    colorBlueValue = checkNumericParam('#colorBlue', colorBlueValue, -1.0, 1.0)
}

//--------------------------------------------------------------
function init() {
    updateViewParams()
    
    let canvas = document.querySelector('#canvas1')
    let gl = setupGL(canvas)
    
    gl.activeTexture(gl.TEXTURE0)
    
    let depthTexLeft = gl.createTexture()
    gl.bindTexture(gl.TEXTURE_2D, depthTexLeft)
    gl.texImage2D(gl.TEXTURE_2D, 0, gl.DEPTH_COMPONENT32F, gl.canvas.width, gl.canvas.height, 0, gl.DEPTH_COMPONENT, gl.FLOAT, null)
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST)
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST)
    
    let fboLeft = gl.createFramebuffer()
    gl.bindFramebuffer(gl.FRAMEBUFFER, fboLeft)
    gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.TEXTURE_2D, depthTexLeft, 0)
    
    let depthTexRight = gl.createTexture()
    gl.bindTexture(gl.TEXTURE_2D, depthTexRight)
    gl.texImage2D(gl.TEXTURE_2D, 0, gl.DEPTH_COMPONENT32F, gl.canvas.width, gl.canvas.height, 0, gl.DEPTH_COMPONENT, gl.FLOAT, null)
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST)
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST)
    
    let fboRight = gl.createFramebuffer()
    gl.bindFramebuffer(gl.FRAMEBUFFER, fboRight)
    gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.TEXTURE_2D, depthTexRight, 0)
    
    gl.bindFramebuffer(gl.FRAMEBUFFER, null)
    
    let scene = new Scene(gl)
    let pad = new Pad(gl)
    
    function draw() {
        gl.clearColor(0.0, 0.0, 0.0, 1.0)
        
        gl.bindFramebuffer(gl.FRAMEBUFFER, fboLeft)
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT)
        scene.draw(-eyesDistanceMillis / 2)
        
        gl.bindFramebuffer(gl.FRAMEBUFFER, fboRight)
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT)
        scene.draw(eyesDistanceMillis / 2)
        
        gl.bindFramebuffer(gl.FRAMEBUFFER, null)
        gl.clearColor(0.7, 0.0, 0.0, 1.0)
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT)
        pad.draw(depthTexLeft, depthTexRight)
    }
    
    let resizeObserver = new ResizeObserver((entries) => {
        for ( const entry of entries ) {
            if ( entry.target===canvas ) {
                canvas.width = entry.contentRect.width
                canvas.height = entry.contentRect.height
                console.log(`New canvas size: ${canvas.width} / ${canvas.height}`)
                
                gl.viewport(0, 0, canvas.width, canvas.height)
                
                gl.bindTexture(gl.TEXTURE_2D, depthTexLeft)
                gl.texImage2D(gl.TEXTURE_2D, 0, gl.DEPTH_COMPONENT32F, gl.canvas.width, gl.canvas.height, 0, gl.DEPTH_COMPONENT, gl.FLOAT, null)
                
                gl.bindTexture(gl.TEXTURE_2D, depthTexRight)
                gl.texImage2D(gl.TEXTURE_2D, 0, gl.DEPTH_COMPONENT32F, gl.canvas.width, gl.canvas.height, 0, gl.DEPTH_COMPONENT, gl.FLOAT, null)
                
                pad.initParams()
            }
        }
        requestAnimationFrame(draw)
    })
    resizeObserver.observe(canvas)
    
    document.querySelector('#fsbutton').onclick = (evt) => {
        if (!document.fullscreenElement) {
            canvas.requestFullscreen()
        }
    }
    
    document.addEventListener("keydown", (evt) => {
        if (evt.code == "KeyF") {
            if ( document.fullscreenElement ) {
                document.exitFullscreen()
            } else {
                canvas.requestFullscreen()
            }
        }
    })
    
    canvas.onwheel = (evt) => {
        const distCoef = 1.01
        if ( evt.wheelDelta > 0 && scene.distance > distanceToScreenMillis + depthMillis / 2 ) scene.distance /= distCoef
        else if ( evt.wheelDelta < 0 ) scene.distance *= distCoef
        requestAnimationFrame(draw)
    }
    
    canvas.onpointerdown = (downEvt) => {
        canvas.setPointerCapture(downEvt.pointerId)
        
        let startAlpha = scene.alpha
        let startBeta = scene.beta
        
        canvas.onpointermove = (moveEvt) => {
            const xSensitivity = 0.015
            const ySensitivity = 0.015
            
            scene.alpha = startAlpha + (moveEvt.x - downEvt.x) * xSensitivity
            while ( scene.alpha < -Math.PI ) scene.alpha += Math.PI*2
            while ( scene.alpha > Math.PI ) scene.alpha -= Math.PI*2
            scene.beta = startBeta + (moveEvt.y - downEvt.y) * ySensitivity
            if ( scene.beta < -Math.PI*0.5 ) scene.beta = -Math.PI*0.5
            if ( scene.beta > Math.PI*0.5 ) scene.beta = Math.PI*0.5
            
            requestAnimationFrame(draw)
        }
    }
    
    canvas.onpointerup = (evt) => {
        canvas.onpointermove = null
        canvas.releasePointerCapture(evt.pointerId)
    }
    
    for ( const paramId of ['#screenWidth', '#distanceToScreen', '#eyesDistance'] ) {
        let element = document.querySelector(paramId)
        element.oninput = (evt) => {
            element.style.background = '#FF8080'
        }
        
        element.onchange = (evt) => {
            updateViewParams()
            pad.initParams()
            requestAnimationFrame(draw)
        }
    }
    
    for ( const paramId of ['#colorRed', '#colorGreen', '#colorBlue'] ) {
        let element = document.querySelector(paramId)
        element.oninput = (evt) => {
            updateViewParams()
            requestAnimationFrame(draw)
        }
    }
    
    requestAnimationFrame(draw)
}

//--------------------------------------------------------------
</script>

<style>
html,
body {
  height: 100%;
  display: flex;
  flex-direction: column;
}

#header {
    background: #f0f0f0;
}

canvas {
    height: 100%;
}

#fscell {
    position: relative;
}

#fsbutton {
    position: absolute;
    top: 0;
    height: 100%;
}

.underline {
    text-decoration: underline;
}

</style>

</head>
<body onload="init()">
    <div id="header">
        <table>
            <tr>
                <td>Eyes distance (mm)</td>
                <td><input id="eyesDistance" /></td>
                <td>R</td>
                <td><input type="range" id="colorRed" min="-1" max="1" step="any" /></td>
                <td rowspan="4" id="fscell"><button id="fsbutton"><span class="underline">F</span>ullscreen</button></td>
            </tr>
            <tr>
                <td>Screen width (mm)</td>
                <td><input id="screenWidth" /></td>
                <td>G</td>
                <td><input type="range" id="colorGreen" min="-1" max="1" step="any" /></td>
            </tr>
            <tr>
                <td>Distance to screen (mm)</td>
                <td><input id="distanceToScreen" /></td>
                <td>B</td>
                <td><input type="range" id="colorBlue" min="-1" max="1" step="any" /></td>
            </tr>
            <tr>
                <td>Update entire canvas</td>
                <td><input type="checkbox" id="updateEntireCanvas" /></td>
            </tr>
        </table>
    </div>
    
    <canvas id="canvas1" oncontextmenu="return false"></canvas>
</body>
</html>
